<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition | Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent: #238636;
            --danger: #da3633;
            --border: #30363d;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: rgba(22, 27, 34, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h2 {
            font-weight: 600;
            margin: 0;
        }

        /* Upload Card */
        .upload-zone {
            background: var(--card-bg);
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 3rem;
            cursor: pointer;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(35, 134, 54, 0.05);
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            font-family: inherit;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: var(--danger);
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        input[type="file"] {
            display: none;
        }

        input[type="text"] {
            background: #0d1117;
            border: 1px solid var(--border);
            color: white;
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
            width: 100%;
            max-width: 300px;
            font-family: inherit;
        }

        /* Grid */
        .faces-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .face-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.2s;
        }

        .face-card:hover {
            transform: translateY(-4px);
            border-color: var(--text-secondary);
        }

        .avatar {
            width: 80px;
            height: 80px;
            background: #21262d;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .face-name {
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* Modal */
        #modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        #modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        /* Tables & Badges */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: rgba(48, 54, 61, 0.5);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge.verified {
            background: rgba(35, 134, 54, 0.2);
            color: #3fb950;
            border: 1px solid #3fb950;
        }

        .badge.danger {
            background: rgba(218, 54, 51, 0.2);
            color: #f85149;
            border: 1px solid #da3633;
        }

        .badge.warning {
            background: rgba(210, 153, 34, 0.2);
            color: #e3b341;
            border: 1px solid #d29922;
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div style="display:flex; align-items:center; gap:1rem;">
            <a href="/" class="brand">FaceRec System</a>
            <a href="/" style="color:var(--text-secondary); text-decoration:none;">Go to Live View &rarr;</a>
        </div>
        <input type="password" id="adminToken" placeholder="Admin Token"
            style="padding:0.5rem; background:#0d1117; border:1px solid #30363d; color:white; border-radius:4px;"
            onchange="localStorage.setItem('admin_token', this.value)">
    </nav>

    <div class="container">

        <div class="section-header">
            <h2>Live Sessions</h2>
            <div class="badge verified" id="activeCount">0 Active</div>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Session ID</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Confidence</th>
                    <th>Warnings</th>
                    <th>Seen</th>
                    <th>View</th>
                </tr>
            </thead>
            <tbody id="sessionTableBody"></tbody>
        </table>

        <!-- STREAM MODAL -->
        <div id="streamModal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; align-items:center; justify-content:center; flex-direction: column;">
            <h3 style="color:white; margin-bottom:1rem;" id="streamTitle">Student View</h3>
            <img id="streamImage" src="" alt="Waiting..."
                style="max-width:90%; max-height:80vh; border:1px solid #333;">
            <br>
            <button class="btn btn-danger" onclick="closeStreamModal()" style="margin-top:1rem;">Close Stream</button>
        </div>

        <div class="section-header">
            <div>
                <h2>Manage Known Faces</h2>
                <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem;">
                    <span id="serviceStatusDot"
                        style="width:10px; height:10px; border-radius:50%; background:gray;"></span>
                    <span id="serviceStatusText" style="color:var(--text-secondary); font-size:0.9rem;">Checking
                        service...</span>
                </div>
            </div>
            <div style="display:flex; gap:1rem;">
                <button class="btn" id="toggleServiceBtn" onclick="toggleService()"
                    style="background:#30363d;">Loading...</button>
                <button class="btn" onclick="openUploadModal()">+ Add New Face</button>
            </div>
        </div>

        <!-- Faces Grid -->
        <div class="faces-grid" id="facesGrid">
            {% for name in faces %}
            <div class="face-card" id="card-{{name}}">
                <div class="avatar">{{ name[0] | upper }}</div>
                <div class="face-name">{{ name }}</div>
                <button class="btn btn-danger" onclick="deleteFace('{{name}}')">Delete</button>
            </div>
            {% endfor %}
        </div>

        {% if not faces %}
        <div style="text-align:center; padding: 4rem; color: var(--text-secondary);">
            No registered faces found.
        </div>
        {% endif %}

    </div>

    <!-- Upload Modal -->
    <div id="modal">
        <div class="modal-content">
            <h3>Add New Face</h3>
            <p style="color:var(--text-secondary);">Upload a clear photo (JPG/PNG)</p>

            <input type="file" id="fileInput" accept="image/*">
            <button class="btn" onclick="document.getElementById('fileInput').click()"
                style="background:#21262d; border:1px solid var(--border); width:100%; margin-bottom:1rem;">Select
                Photo</button>
            <div id="fileName" style="margin-bottom:1rem; font-size:0.9rem;"></div>

            <input type="text" id="nameInput" placeholder="Enter Person's Name">

            <div style="margin-top:2rem; display:flex; gap:1rem; justify-content:center;">
                <button class="btn" onclick="uploadFace()">Save Face</button>
                <button class="btn" style="background:transparent; border:1px solid var(--border);"
                    onclick="closeModal()">Cancel</button>
            </div>
            <div id="statusMsg" style="margin-top:1rem; font-size:0.9rem;"></div>
        </div>
    </div>

    <script>
        document.getElementById('adminToken').value = localStorage.getItem('admin_token') || '';

        // --- DASHBOARD LOGIC ---
        let isStreamActive = false;

        async function updateDashboard() {
            try {
                const token = localStorage.getItem('admin_token');
                const headers = token ? { 'X-ADMIN-TOKEN': token } : {};

                const res = await fetch('/api/admin/stats', { headers });
                if (!res.ok) return;

                const data = await res.json();
                renderTable(data.sessions);
                document.getElementById('activeCount').innerText = `${data.active_count} Active`;
            } catch (e) { }
        }

        function renderTable(sessions) {
            const tbody = document.getElementById('sessionTableBody');
            tbody.innerHTML = '';

            const sorted = Object.entries(sessions).sort(([, a], [, b]) => b.total_warnings - a.total_warnings);

            sorted.forEach(([sid, s]) => {
                const tr = document.createElement('tr');
                let badge = 'verified';
                if (s.status.includes('multiple') || s.status.includes('missing')) badge = 'danger';
                else if (s.status.includes('unstable')) badge = 'warning';

                const timeAgo = Math.round((new Date() - new Date(s.last_seen)) / 1000);

                tr.innerHTML = `
                    <td style="font-family:monospace; font-size:0.9rem;">${sid.substring(0, 8)}...</td>
                    <td><strong>${s.current_name}</strong></td>
                    <td><span class="badge ${badge}">${s.status.toUpperCase()}</span></td>
                    <td>${s.confidence}%</td>
                    <td>${s.total_warnings > 0 ? `<span class="badge danger">${s.total_warnings}</span>` : '0'}</td>
                    <td style="color:#888;">${timeAgo}s ago</td>
                    <td><button class="btn" style="padding:0.4rem 0.8rem; font-size:0.8rem;" onclick="viewStream('${sid}')">View</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function viewStream(sid) {
            const modal = document.getElementById('streamModal');
            document.getElementById('streamImage').src = "";
            modal.style.display = 'flex';
            document.getElementById('streamTitle').innerText = `Session: ${sid}`;

            isStreamActive = true;
            pollStream(sid);
        }

        async function pollStream(sid) {
            if (!isStreamActive) return;

            const img = document.getElementById('streamImage');
            const token = localStorage.getItem('admin_token');
            const headers = token ? { 'X-ADMIN-TOKEN': token } : {};

            try {
                const res = await fetch(`/api/admin/frame/${sid}`, { headers });
                if (res.ok && res.status === 200) {
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);

                    if (img.src.startsWith('blob:')) URL.revokeObjectURL(img.src);
                    img.src = url;
                }
            } catch (e) {
                console.error(e);
            }

            if (isStreamActive) setTimeout(() => pollStream(sid), 1000); // 1s delay
        }

        function closeStreamModal() {
            document.getElementById('streamModal').style.display = 'none';
            isStreamActive = false;
        }

        setInterval(updateDashboard, 2000);
        updateDashboard();


        // Service Control Logic
        async function fetchServiceStatus() {
            try {
                const res = await fetch('/api/service_status');
                const data = await res.json();
                updateServiceUI(data.active);
            } catch (e) {
                console.error("Failed to fetch status");
            }
        }

        async function toggleService() {
            const btn = document.getElementById('toggleServiceBtn');
            const isStop = btn.innerText.includes("Stop");
            const action = isStop ? 'stop' : 'start';

            btn.innerText = "Processing...";

            try {
                const res = await fetch('/api/toggle_service', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action })
                });
                const data = await res.json();
                if (data.success) {
                    updateServiceUI(data.active);
                }
            } catch (e) {
                alert("Error toggling service");
            }
        }

        function updateServiceUI(active) {
            const dot = document.getElementById('serviceStatusDot');
            const text = document.getElementById('serviceStatusText');
            const btn = document.getElementById('toggleServiceBtn');

            if (active) {
                dot.style.background = "var(--accent)";
                dot.style.boxShadow = "0 0 8px var(--accent)";
                text.textContent = "Service Active";
                text.style.color = "var(--accent)";
                btn.innerText = "Stop Service";
                btn.style.background = "var(--danger)";
            } else {
                dot.style.background = "var(--danger)";
                dot.style.boxShadow = "none";
                text.textContent = "Service Stopped";
                text.style.color = "var(--danger)";
                btn.innerText = "Start Service";
                btn.style.background = "var(--accent)";
            }
        }

        // Initial Load
        fetchServiceStatus();

        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                document.getElementById('fileName').textContent = "Selected: " + e.target.files[0].name;
            }
        });

        function openUploadModal() {
            document.getElementById('modal').classList.add('active');
            document.getElementById('nameInput').value = '';
            document.getElementById('fileName').textContent = '';
            fileInput.value = '';
            document.getElementById('statusMsg').textContent = '';
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        async function uploadFace() {
            const file = fileInput.files[0];
            const name = document.getElementById('nameInput').value;
            const statusFn = document.getElementById('statusMsg');

            if (!file || !name) {
                statusFn.textContent = "Please select a file and enter a name.";
                statusFn.style.color = "var(--danger)";
                return;
            }

            statusFn.textContent = "Uploading...";
            statusFn.style.color = "var(--text-secondary)";

            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', name);

            try {
                const res = await fetch('/api/upload_face', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    statusFn.textContent = "Success! Reloading...";
                    statusFn.style.color = "var(--accent)";
                    setTimeout(() => location.reload(), 1000);
                } else {
                    statusFn.textContent = data.error || "Upload failed.";
                    statusFn.style.color = "var(--danger)";
                }
            } catch (e) {
                statusFn.textContent = "Error: " + e.message;
                statusFn.style.color = "var(--danger)";
            }
        }

        async function deleteFace(name) {
            if (!confirm(`Are you sure you want to delete ${name}?`)) return;

            try {
                const res = await fetch('/api/delete_face', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById(`card-${name}`).remove();
                } else {
                    alert(data.error);
                }
            } catch (e) {
                alert("Error deleting face");
            }
        }
    </script>
</body>

</html>